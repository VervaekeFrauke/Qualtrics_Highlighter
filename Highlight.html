<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Qualtrics Highlighter</title>

<style>
  body {
    font-family: sans-serif;
    padding: 20px;
    line-height: 1.6;
  }

  #textContainer {
    border: 1px solid #ddd;
    padding: 15px;
    border-radius: 6px;
  }

  .char {
    cursor: pointer;
    white-space: pre-wrap;
  }

  .highlighted {
    background-color: yellow;
  }
</style>
</head>
<body>

<h3>Please highlight any part of the text:</h3>

<div id="textContainer"></div>

<script>
// ------------------------------------------------------------
// 1. CONFIGURE TEXT HERE
// ------------------------------------------------------------
const rawText = `Lorem ipsum dolor sit amet, consectetur adipiscing elit. 
Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua.`;

// ------------------------------------------------------------
// 2. BUILD SAFE CHARACTER SPANS
// ------------------------------------------------------------
function buildText() {
    const container = document.getElementById("textContainer");
    container.innerHTML = "";

    [...rawText].forEach((ch, idx) => {
        const span = document.createElement("span");
        span.classList.add("char");
        span.dataset.index = idx;
        span.textContent = ch;

        span.addEventListener("click", () => toggleHighlight(span));
        container.appendChild(span);
    });
}

// ------------------------------------------------------------
// 3. SINGLE-CHARACTER HIGHLIGHT TOGGLE
// ------------------------------------------------------------
function toggleHighlight(span) {
    span.classList.toggle("highlighted");
}

// ------------------------------------------------------------
// 4. COLLECT HIGHLIGHTS IN TEXT ORDER
// ------------------------------------------------------------
function collectHighlightsInOrder() {
    const highlighted = [...document.querySelectorAll(".highlighted")];
    highlighted.sort((a, b) => Number(a.dataset.index) - Number(b.dataset.index));

    // Merge consecutive highlighted characters into one string
    const groups = [];
    let current = [];

    highlighted.forEach((span, i) => {
        const idx = Number(span.dataset.index);
        const prevIdx = i > 0 ? Number(highlighted[i-1].dataset.index) : null;

        if (prevIdx !== null && idx === prevIdx + 1) {
            current.push(span.textContent);
        } else {
            if (current.length) groups.push(current.join(""));
            current = [span.textContent];
        }
    });

    if (current.length) groups.push(current.join(""));

    return groups;
}

// ------------------------------------------------------------
// 5. SEND TO QUALTRICS VIA postMessage
// ------------------------------------------------------------
function sendToQualtrics() {
    const highlights = collectHighlightsInOrder();

    parent.postMessage({
        type: "qualtricsHighlightData",
        highlights: highlights
    }, "*");
}

// ------------------------------------------------------------
// 6. LISTEN FOR "qualtricsNext"
// ------------------------------------------------------------
window.addEventListener("message", (event) => {
    if (event.data === "qualtricsNext") {
        sendToQualtrics();
    }
});

// ------------------------------------------------------------
// 7. INITIALIZE
// ------------------------------------------------------------
buildText();
</script>

</body>
</html>
