<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Qualtrics Highlighter</title>
<style>
  body {
    font-family: sans-serif;
    padding: 20px;
    line-height: 1.6;
  }
  #textContainer {
    border: 1px solid #ddd;
    padding: 15px;
    border-radius: 6px;
    user-select: none; /* disable native selection */
  }
  .char {
    cursor: pointer;
    white-space: pre-wrap;
  }
  .highlighted {
    background-color: yellow;
  }
</style>
</head>
<body>

<h3>Please highlight any part of the text:</h3>
<div id="textContainer"></div>

<script>
// ----------------------------
// 1. Configure text
// ----------------------------
const rawText = `Lorem ipsum dolor sit amet, consectetur adipiscing elit. 
Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua.`;

// ----------------------------
// 2. Build character spans
// ----------------------------
function buildText() {
    const container = document.getElementById("textContainer");
    container.innerHTML = "";

    [...rawText].forEach((ch, idx) => {
        const span = document.createElement("span");
        span.classList.add("char");
        span.dataset.index = idx;
        span.textContent = ch;

        // Drag-to-highlight & click-to-unhighlight handled later
        container.appendChild(span);
    });

    attachEvents();
}

// ----------------------------
// 3. Drag & click events
// ----------------------------
function attachEvents() {
    let isDragging = false;

    const container = document.getElementById("textContainer");
    container.addEventListener("mousedown", () => { isDragging = true; });
    window.addEventListener("mouseup", () => { isDragging = false; });

    const chars = [...document.querySelectorAll(".char")];
    chars.forEach(span => {
        span.addEventListener("mouseover", () => {
            if (isDragging) span.classList.add("highlighted");
        });
        span.addEventListener("click", () => {
            span.classList.toggle("highlighted");
        });
    });
}

// ----------------------------
// 4. Collect consecutive highlights
// ----------------------------
function collectHighlightsInOrder() {
    const highlighted = [...document.querySelectorAll(".highlighted")];
    highlighted.sort((a,b)=>Number(a.dataset.index)-Number(b.dataset.index));

    const groups = [];
    let current = [];

    highlighted.forEach((span,i) => {
        const idx = Number(span.dataset.index);
        const prevIdx = i>0 ? Number(highlighted[i-1].dataset.index) : null;

        if (prevIdx!==null && idx === prevIdx+1) {
            current.push(span.textContent);
        } else {
            if (current.length) groups.push(current.join(""));
            current = [span.textContent];
        }
    });
    if (current.length) groups.push(current.join(""));
    return groups;
}

// ----------------------------
// 5. Send highlights to Qualtrics
// ----------------------------
function sendToQualtrics() {
    const highlights = collectHighlightsInOrder();
  console.log("Sending highlights:", highlights);

    // Use ancestorOrigins if available to set Qualtrics origin
    const qualtricsOrigin = window.location.ancestorOrigins?.[0] || "*";

    parent.postMessage({
        type: "qualtricsHighlightData",
        highlights: highlights
    }, qualtricsOrigin);
}

// ----------------------------
// 6. Listen for Qualtrics Next
// ----------------------------
window.addEventListener("message", (event) => {
    // Accept messages only from GitHub Pages origin
    if (event.origin !== "https://vervaekefrauke.github.io") return;

    if(event.data === "qualtricsNext") sendToQualtrics();
});

// ----------------------------
// 7. Initialize
// ----------------------------
buildText();
</script>

</body>
</html>

